<!doctype html>
<html lang="es" class="dark:[color-scheme:dark]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero ‚Äî Presupuestos (Conectado)</title>
  
  <script>
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1. URL Correcta (mn)
    const SUPABASE_URL = "https://iznmnrtqujgdwwbglyjo.supabase.co";
    // 2. Clave ANON Correcta (Legacy)
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bm1ucnRxdWpnZHd3YmdseWpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTEzMjksImV4cCI6MjA4MDQyNzMyOX0.tiebM-ygg8_jA_7Om5ZRFAz-gZlE9zJToBsoesbTZL4";

    const { createClient } = window.supabase;
    window._supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    :root{
      --brandA: 245, 158, 11; /* amber-500 */
      --brandB: 59, 130, 246; /* blue-500  */
      --brandC: 16, 185, 129; /* emerald-500 */
      --brandD: 236, 72, 153; /* pink-500 */
    }
    body{
      background:
        radial-gradient(900px 400px at 10% -5%, rgba(var(--brandB), .12), transparent 50%),
        radial-gradient(900px 400px at 90% 105%, rgba(var(--brandA), .12), transparent 50%),
        linear-gradient(180deg, #fff7ed 0%, #eff6ff 50%, #f0fdf4 100%);
    }
    .dark body{
      background:
        radial-gradient(900px 400px at 10% -5%, rgba(var(--brandB), .12), transparent 50%),
        radial-gradient(900px 400px at 90% 105%, rgba(var(--brandA), .12), transparent 50%),
        linear-gradient(180deg, #0b1220 0%, #0b1220 50%, #0b1220 100%);
    }
    .glass{ backdrop-filter: blur(10px); background: rgba(255,255,255,.7); }
    .dark .glass{ background: rgba(2,6,23,.6); }
    .chip{ padding:.35rem .7rem; border-radius:9999px; font-size:.8rem; cursor: pointer; transition: all 0.2s; }
    .chip:hover { transform: translateY(-1px); }
    
    .kpi-gradient-1{ background: linear-gradient(135deg, rgba(var(--brandB),.12), rgba(var(--brandA),.12)); }
    .kpi-gradient-2{ background: linear-gradient(135deg, rgba(var(--brandC),.12), rgba(var(--brandD),.12)); }
    .kpi-gradient-3{ background: linear-gradient(135deg, rgba(244,63,94,.12), rgba(var(--brandC),.12)); }
    .kpi-gradient-4{ background: linear-gradient(135deg, rgba(168,85,247,.12), rgba(234,179,8,.12)); }
    
    .table-elegant thead tr{ background: linear-gradient(90deg, rgba(2,6,23,.04), rgba(2,6,23,.02)); }
    .dark .table-elegant thead tr{ background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.04)); }
    .table-elegant tbody tr:nth-child(odd){ background: rgba(2,6,23,.02); }
    .dark .table-elegant tbody tr:nth-child(odd){ background: rgba(255,255,255,.03); }
    .full-bleed{ width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; }
  </style>
</head>
<body class="min-h-screen text-slate-800 dark:text-slate-100 font-sans">
  
  <header class="sticky top-0 z-30 border-b border-white/40 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 glass">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl flex items-center justify-center text-white font-bold shadow-lg" style="background:conic-gradient(from 160deg, #2563eb, #0ea5e9, #14b8a6, #94a3b8, #2563eb)">AY</div>
        <div class="font-semibold text-lg hidden sm:block">Tablero de Control</div>
      </div>
      
      <div class="flex items-center gap-2 sm:gap-3">
        <select id="filtroFecha" class="chip bg-white/80 text-slate-700 border border-slate-200 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
          <option value="este_mes">üìÖ Este Mes</option>
          <option value="mes_pasado">‚è™ Mes Pasado</option>
          <option value="todos">üìÇ Ver Todos</option>
        </select>

        <button id="btnRefresh" class="chip bg-white/80 text-blue-600 border border-slate-200 dark:bg-slate-800 dark:text-blue-400 dark:border-slate-700" title="Actualizar datos">üîÑ</button>
        <button id="btnTheme" class="chip bg-white/80 text-slate-700 border border-slate-200 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700" title="Modo oscuro">üåô</button>
        
        <a href="index.html" class="chip bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-medium hover:bg-slate-800">
          + Nuevo
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 glass kpi-gradient-1 p-4 shadow-sm relative overflow-hidden">
        <div class="text-sm text-slate-600 dark:text-slate-300 font-medium uppercase tracking-wider">Total Cotizado</div>
        <div id="kpiTotal" class="text-3xl font-extrabold tracking-tight mt-1 text-slate-900 dark:text-white">‚Äî</div>
        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Suma total del per√≠odo</div>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 glass kpi-gradient-2 p-4 shadow-sm">
        <div class="text-sm text-slate-600 dark:text-slate-300 font-medium uppercase tracking-wider">Presupuestos</div>
        <div id="kpiCant" class="text-3xl font-extrabold tracking-tight mt-1 text-slate-900 dark:text-white">‚Äî</div>
        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Cantidad emitida</div>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 glass kpi-gradient-3 p-4 shadow-sm">
        <div class="text-sm text-slate-600 dark:text-slate-300 font-medium uppercase tracking-wider">Promedio</div>
        <div id="kpiAvg" class="text-3xl font-extrabold tracking-tight mt-1 text-slate-900 dark:text-white">‚Äî</div>
        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Valor medio por trabajo</div>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 glass kpi-gradient-4 p-4 shadow-sm">
        <div class="text-sm text-slate-600 dark:text-slate-300 font-medium uppercase tracking-wider">Aprobados</div>
        <div id="kpiAprobMonto" class="text-3xl font-extrabold tracking-tight mt-1 text-slate-900 dark:text-white">‚Äî</div>
        <div id="kpiAprobTxt" class="text-xs text-slate-500 dark:text-slate-400 mt-1">0 trabajos confirmados</div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
      <div class="bg-white/70 dark:bg-slate-900/70 glass rounded-2xl border border-slate-200 dark:border-slate-800 p-5 shadow-sm col-span-2">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold">Tipos de trabajo</h3>
          <span class="text-xs text-slate-400 uppercase font-bold">Por cantidad</span>
        </div>
        <div class="relative h-60 w-full">
          <canvas id="chartTipos"></canvas>
        </div>
      </div>

      <div class="bg-white/70 dark:bg-slate-900/70 glass rounded-2xl border border-slate-200 dark:border-slate-800 p-5 shadow-sm lg:col-span-1">
        <h3 class="text-base font-semibold mb-4">Top Ubicaciones</h3>
        <ul id="topUbic" class="space-y-3 text-sm">
          <li class="text-slate-400 text-center py-4">Cargando...</li>
        </ul>
      </div>
    </section>
  </main>

  <section class="full-bleed px-4 sm:px-6 pb-16 bg-white/50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto pt-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Detalle de Presupuestos</h3>
        <div class="text-xs text-slate-500" id="dbStatus">Sincronizado con Supabase</div>
      </div>
      
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm table-elegant">
            <thead>
              <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-800">
                <th class="py-3 px-4 font-semibold">Fecha</th>
                <th class="py-3 px-4 font-semibold">Comitente</th>
                <th class="py-3 px-4 font-semibold">Trabajo</th>
                <th class="py-3 px-4 font-semibold">Ubicaci√≥n</th>
                <th class="py-3 px-4 font-semibold text-right">Monto</th>
                <th class="py-3 px-4 font-semibold text-center">Estado</th>
                <th class="py-3 px-4 font-semibold text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyRows">
              <tr><td colspan="7" class="py-10 text-center text-slate-400">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script>
    // --- L√ìGICA DEL SISTEMA ---
    
    // Variables Globales
    let allData = [];
    let chartTiposInstance = null;
    
    // Configuraci√≥n Gr√°fica
    const PALETTE = ['#3b82f6', '#f59e0b', '#10b981', '#ec4899', '#8b5cf6', '#6366f1', '#06b6d4', '#f43f5e'];
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';

    // Helpers
    const money = (n, c="ARS") => new Intl.NumberFormat('es-AR', { style: 'currency', currency: c, maximumFractionDigits: 0 }).format(n || 0);
    const el = (id) => document.getElementById(id);

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      initTheme();
      loadData();
      
      // Listeners
      el('filtroFecha').addEventListener('change', renderUI);
      el('btnRefresh').addEventListener('click', loadData);
    });

    // 1. CARGA DE DATOS (SUPABASE)
    async function loadData() {
      const tbody = el('tbodyRows');
      
      try {
        // Fetch
        let { data, error } = await window._supabase
          .from('COTIZACIONES')
          .select('*')
          .order('fecha', { ascending: false });

        if (error) throw error;

        allData = data || [];
        renderUI();

      } catch (e) {
        console.error("Error cargando:", e);
        tbody.innerHTML = `<tr><td colspan="7" class="py-8 text-center text-rose-500">Error de conexi√≥n: ${e.message}</td></tr>`;
      }
    }

    // 2. RENDERIZADO DE INTERFAZ (Filtros + Tabla + Gr√°ficos)
    function renderUI() {
      const filtro = el('filtroFecha').value;
      const filteredData = applyFilter(allData, filtro);
      
      updateKPIs(filteredData);
      renderTable(filteredData);
      renderCharts(filteredData);
    }

    // Filtros de fecha
    function applyFilter(data, filtro) {
      const hoy = new Date();
      const mesActual = hoy.getMonth();
      const anoActual = hoy.getFullYear();

      return data.filter(item => {
        if (filtro === 'todos') return true;
        
        // Fix zona horaria
        const fecha = new Date(item.fecha + "T00:00:00");
        const m = fecha.getMonth();
        const y = fecha.getFullYear();

        if (filtro === 'este_mes') return m === mesActual && y === anoActual;
        if (filtro === 'mes_pasado') {
          const pastDate = new Date(anoActual, mesActual - 1, 1);
          return m === pastDate.getMonth() && y === pastDate.getFullYear();
        }
        return true;
      });
    }

    // Actualizar KPIs
    function updateKPIs(data) {
      const total = data.reduce((sum, item) => sum + (item.monto || 0), 0);
      const cant = data.length;
      const aprobados = data.filter(i => i.aprobado);
      const totalAprob = aprobados.reduce((sum, item) => sum + (item.monto || 0), 0);
      const avg = cant ? total / cant : 0;

      el('kpiTotal').textContent = money(total);
      el('kpiCant').textContent = cant;
      el('kpiAvg').textContent = money(avg);
      el('kpiAprobMonto').textContent = money(totalAprob);
      el('kpiAprobTxt').textContent = `${aprobados.length} trabajos confirmados`;
    }

    // Renderizar Tabla
    function renderTable(data) {
      const tbody = el('tbodyRows');
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="py-10 text-center text-slate-400">No hay datos en este per√≠odo.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(item => {
        const [y, m, d] = (item.fecha || "----").split("-");
        const fechaFmt = `${d}/${m}/${y}`;
        const cliente = item.comitente || "‚Äî";
        const lugar = item.ubicacion || "‚Äî";
        
        // El checkbox llama a toggleStatus(ID, estadoActual)
        // El bot√≥n borrar llama a deleteItem(ID)
        return `
          <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
            <td class="py-3 px-4 font-mono text-xs text-slate-500">${fechaFmt}</td>
            <td class="py-3 px-4 font-medium">${cliente}</td>
            <td class="py-3 px-4 text-blue-600 dark:text-blue-400 text-xs uppercase font-bold">${item.tipo}</td>
            <td class="py-3 px-4 text-slate-500 text-sm">${lugar}</td>
            <td class="py-3 px-4 text-right font-mono font-medium">${money(item.monto, item.moneda)}</td>
            <td class="py-3 px-4 text-center">
              <label class="inline-flex items-center cursor-pointer relative group">
                <input type="checkbox" ${item.aprobado ? 'checked' : ''} 
                       onchange="toggleStatus(${item.id}, ${item.aprobado})" 
                       class="sr-only peer">
                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:bg-emerald-500 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">
                  ${item.aprobado ? 'Marcar Pendiente' : 'Aprobar'}
                </span>
              </label>
            </td>
            <td class="py-3 px-4 text-center">
              <button onclick="deleteItem(${item.id})" class="text-slate-400 hover:text-rose-500 transition p-1 rounded-md hover:bg-rose-50 dark:hover:bg-rose-900/30" title="Eliminar permanentemente">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Renderizar Gr√°ficos
    function renderCharts(data) {
      // 1. Tipos de trabajo
      const counts = {};
      const ubis = {};
      
      data.forEach(x => {
        counts[x.tipo] = (counts[x.tipo] || 0) + 1;
        ubis[x.ubicacion || 'Sin datos'] = (ubis[x.ubicacion || 'Sin datos'] || 0) + 1;
      });
      
      const labels = Object.keys(counts);
      const values = Object.values(counts);

      // Destruir anterior si existe
      if (chartTiposInstance) chartTiposInstance.destroy();

      const ctx = el('chartTipos').getContext('2d');
      chartTiposInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cantidad',
            data: values,
            backgroundColor: PALETTE,
            borderRadius: 6,
            barThickness: 30
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(200,200,200,0.1)' } },
            x: { grid: { display: false } }
          }
        }
      });

      // 2. Top Ubicaciones (HTML List)
      const sortedUbis = Object.entries(ubis).sort((a,b) => b[1] - a[1]).slice(0, 5);
      el('topUbic').innerHTML = sortedUbis.map(([lugar, cant], i) => `
        <li class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold text-white" style="background:${PALETTE[i % PALETTE.length]}">${i+1}</span>
            <span class="text-slate-700 dark:text-slate-300 truncate max-w-[120px]" title="${lugar}">${lugar}</span>
          </div>
          <span class="chip bg-slate-100 dark:bg-slate-800 text-xs font-bold">${cant}</span>
        </li>
      `).join('') || '<li class="text-center text-slate-400">Sin datos</li>';
    }

    // 3. INTERACCIONES SUPABASE (Update/Delete)
    async function toggleStatus(id, currentStatus) {
      const newStatus = !currentStatus;
      // Actualizaci√≥n optimista (UI primero)
      // Pero mejor recargar para asegurar consistencia
      try {
        const { error } = await window._supabase
          .from('COTIZACIONES')
          .update({ aprobado: newStatus })
          .eq('id', id);

        if (error) throw error;
        loadData(); // Recargar tabla
      } catch (e) {
        alert("Error actualizando: " + e.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm("¬øSeguro que quieres eliminar este presupuesto de la base de datos?")) return;
      
      try {
        const { error } = await window._supabase
          .from('COTIZACIONES')
          .delete()
          .eq('id', id);

        if (error) throw error;
        loadData(); // Recargar tabla
      } catch (e) {
        alert("Error eliminando: " + e.message);
      }
    }

    // --- DARK MODE LOGIC ---
    function initTheme() {
      const btn = el('btnTheme');
      const root = document.documentElement;
      
      // Cargar guardado
      if (localStorage.getItem('theme') === 'dark') root.classList.add('dark');
      
      btn.textContent = root.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
      
      btn.addEventListener('click', () => {
        root.classList.toggle('dark');
        const isDark = root.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      });
    }

  </script>
</body>
</html>
